"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[444],{9915:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return l},contentTitle:function(){return d},metadata:function(){return o},toc:function(){return p},default:function(){return c}});var n=a(7462),i=a(3366),r=(a(7294),a(3905)),s=["components"],l={id:"schema",title:"Schema"},d=void 0,o={unversionedId:"graphql/schema",id:"graphql/schema",isDocsHomePage:!1,title:"Schema",description:"I get paid $40 an hour, so unless you're gonna pay me $40 to write a whole essay",source:"@site/docs/graphql/schema.md",sourceDirName:"graphql",slug:"/graphql/schema",permalink:"/turtle/docs/graphql/schema",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/graphql/schema.md",version:"current",frontMatter:{id:"schema",title:"Schema"},sidebar:"sidebar",previous:{title:"Util",permalink:"/turtle/docs/server/util"}},p=[{value:"Required interfaces",id:"required-interfaces",children:[{value:"<code>Node</code>",id:"node",children:[]},{value:"<code>UserJwt</code>",id:"userjwt",children:[]}]},{value:"Directives",id:"directives",children:[{value:"<code>@secret</code>",id:"secret",children:[]},{value:"<code>@index</code>",id:"index",children:[]},{value:"<code>@tag</code>",id:"tag",children:[]}]}],h={toc:p};function c(e){var t=e.components,a=(0,i.Z)(e,s);return(0,r.kt)("wrapper",(0,n.Z)({},h,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"I get paid $40 an hour, so unless you're gonna pay me $40 to write a whole essay\nabout how GraphQL schemas work, just click\n",(0,r.kt)("a",{parentName:"p",href:"https://graphql.org/learn/schema/"},"here")," and read it from the experts. By the\nway, I only get paid $40 an hour for like 2 more weeks, so if you can pay me $40\nI'd appreciate it."),(0,r.kt)("p",null,"There are some requirements for a schema that aren't official in GraphQL but I'm\nmaking them official here."),(0,r.kt)("h2",{id:"required-interfaces"},"Required interfaces"),(0,r.kt)("h3",{id:"node"},(0,r.kt)("inlineCode",{parentName:"h3"},"Node")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"Node")," interface is a generic type for anything that has an ID. It should\nhave an index and a tag on the id field for\n",(0,r.kt)("a",{parentName:"p",href:"https://graphql.org/learn/global-object-identification/"},"Global Object Identification"),".\nWhat's\n",(0,r.kt)("a",{parentName:"p",href:"https://graphql.org/learn/global-object-identification/"},"Global Object Identification"),"?\nI just linked it twice, just click the damn link."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-graphql"},'interface Node\n@index(name: "nodes", prefix: "nodes:") {\n    id: ID! @tag\n}\n')),(0,r.kt)("h3",{id:"userjwt"},(0,r.kt)("inlineCode",{parentName:"h3"},"UserJwt")),(0,r.kt)("p",null,"This interface has the subset of fields of a user that should be stored in a\nJWT. See the ",(0,r.kt)("a",{parentName:"p",href:"/docs/server/authentication"},"authentication")," for info on what the\nfuck that is."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-graphql"},"interface UserJWT {\n    id: ID!\n    # additional fields...\n}\n")),(0,r.kt)("h2",{id:"directives"},"Directives"),(0,r.kt)("p",null,"The schema has to declare these directives at the top:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-graphql"},"# in graphql/schema.gql\ndirective @secret(name: String!, type: String!) on OBJECT\ndirective @index(name: String!, prefix: String!) on OBJECT | INTERFACE\ndirective @tag on FIELD_DEFINITION\n")),(0,r.kt)("h3",{id:"secret"},(0,r.kt)("inlineCode",{parentName:"h3"},"@secret")),(0,r.kt)("p",null,"Arguments:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"name: String!"),", the name of the field"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"type: String!"),", the TypeScript type of the field")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"@secret")," directive adds a field to the Redis payload of an object that\nisn't exposed to the user, but is stored in the database. This is used for\nadding password fields to user types, for example, and unless you are an idiot\nyou don't want random people being able to query the password."),(0,r.kt)("p",null,"Example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-graphql"},'# in graphql/schema.gql\ntype User implements Node & UserJWT\n@secret(name: "password", type: "string") {\n    id: ID!\n    email: String!\n}\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'// in server/resolvers.ts\n\nimport { RedisPayload, User } from "../graphql/types.ts";\n// ...\nconst payload: RedisPayload["User"] = {\n  id: id,\n  email: args.email,\n  password: password,\n};\nawait Redis.json.set(id, "$", JSON.stringify(payload));\n// ...\n')),(0,r.kt)("p",null,"Here, the type ",(0,r.kt)("inlineCode",{parentName:"p"},'RedisPayload["User"]')," will have the ",(0,r.kt)("inlineCode",{parentName:"p"},"password")," field to be\nstored in the database, but the type ",(0,r.kt)("inlineCode",{parentName:"p"},"User")," will not."),(0,r.kt)("h3",{id:"index"},(0,r.kt)("inlineCode",{parentName:"h3"},"@index")),(0,r.kt)("p",null,"Arguments:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"name: String!"),", the name of the index"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"prefix: String!"),", the prefix for Redis keys on which the index is applied")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"@index")," directive adds a Redis index to all key-value pairs where the keys\nstart with the prefix string. See ",(0,r.kt)("a",{parentName:"p",href:"/docs/server/redis#creating-indexes"},"this"),"\nfor information on how to automatically create the indexes in TypeScript."),(0,r.kt)("p",null,"Example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-graphql"},'# in graphql/schema.gql\ntype User implements Node & UserJWT\n@index(name: "users", prefix: "nodes:users:*:") {\n    id: ID!\n    email: String!\n}\n')),(0,r.kt)("p",null,"This will add an index for all keys that start with ",(0,r.kt)("inlineCode",{parentName:"p"},'"nodes:users:*:"'),"."),(0,r.kt)("h3",{id:"tag"},(0,r.kt)("inlineCode",{parentName:"h3"},"@tag")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"@tag")," directive adds a tagged field as part of a Redis index created with\n",(0,r.kt)("inlineCode",{parentName:"p"},"@index"),". This makes the field searchable."),(0,r.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Using ",(0,r.kt)("inlineCode",{parentName:"p"},"@tag")," in an object that does not have an ",(0,r.kt)("inlineCode",{parentName:"p"},"@index")," results in an error."))),(0,r.kt)("p",null,"Example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-graphql"},'# in graphql/schema.gql\ntype User implements Node & UserJWT\n@index(name: "users", prefix: "nodes:users:*:") {\n    id: ID!\n    email: String! @tag\n}\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'// in server/resolvers.ts\n\nconst escapedEmail = args.email.replaceAll("@", "\\\\@").replaceAll(".", "\\\\.");\nconst search = await Redis.search.search("users", `@email:{${escapedEmail}}`);\nswitch (typeof search) {\n  case "number":\n    throw new Error(`User with email ${args.email} does not exist`);\n  default:\n    break;\n}\nif (search.at(0) as number > 1 || search.length > 3) {\n  throw new Error(`More than one user found with email ${args.email}`);\n}\nconst parsedSearch = search as [1, string, ["$", string]];\nconst userInfo: RedisPayload["User"] = JSON.parse(\n  (parsedSearch.at(2) as ["$", string]).at(1) as string,\n);\n')))}c.isMDXComponent=!0}}]);