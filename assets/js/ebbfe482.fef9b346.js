"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[810],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return p}});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var h=r.createContext({}),l=function(e){var t=r.useContext(h),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=l(e.components);return r.createElement(h.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,h=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=l(n),p=a,m=d["".concat(h,".").concat(p)]||d[p]||u[p]||o;return n?r.createElement(m,i(i({ref:t},c),{},{components:n})):r.createElement(m,i({ref:t},c))}));function p(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=d;var s={};for(var h in t)hasOwnProperty.call(t,h)&&(s[h]=t[h]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var l=2;l<o;l++)i[l]=n[l];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},5806:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return h},metadata:function(){return l},toc:function(){return c},default:function(){return d}});var r=n(7462),a=n(3366),o=(n(7294),n(3905)),i=["components"],s={id:"authentication",title:"Authentication",slug:"/server/authentication"},h=void 0,l={unversionedId:"Server/authentication",id:"Server/authentication",isDocsHomePage:!1,title:"Authentication",description:"Authentication is the way overly complicated way of saying what we allow which",source:"@site/docs/Server/authentication.md",sourceDirName:"Server",slug:"/server/authentication",permalink:"/turtle/docs/server/authentication",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/Server/authentication.md",version:"current",frontMatter:{id:"authentication",title:"Authentication",slug:"/server/authentication"},sidebar:"sidebar",previous:{title:"Schema",permalink:"/turtle/docs/graphql/schema"},next:{title:"Redis",permalink:"/turtle/docs/server/redis"}},c=[{value:"JSON Web Tokens",id:"json-web-tokens",children:[{value:"Access token",id:"access-token",children:[]},{value:"Refresh token",id:"refresh-token",children:[]}]},{value:"Decorators",id:"decorators",children:[{value:"<code>@Auth.authenticated()</code>",id:"authauthenticated",children:[]},{value:"<code>@Auth.rateLimit()</code>",id:"authratelimit",children:[]}]}],u={toc:c};function d(e){var t=e.components,n=(0,a.Z)(e,i);return(0,o.kt)("wrapper",(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"Authentication is the way overly complicated way of saying what we allow which\nusers to do. It's like parental controls, which means that we treat users like\nirresponsbile 5 year olds. Considering the IQs we're dealing with, it's best\nthat it stays that way."),(0,o.kt)("h2",{id:"json-web-tokens"},"JSON Web Tokens"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://jwt.io/introduction"},"JWTs")," are used for authentication. I'm not gonna\nwrite too much about it because the good folks at that link probably wrote a lot\nof informative stuff. Hold on. My lawyers just told me that I can be liable if\nthe g\u2014ah, folks at that link happen to do something terrible like molest a child\nor listen to a Drake song, so I'll just call them folks without commenting on\ntheir alleged goodness."),(0,o.kt)("p",null,"When a user logs in and gives us details that we would never misuse, like their\npasswords credit card information, we create an object that has all the details\nwe need to check who they are. For example,"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "id": "nodes:users:*:70af6899-189c-470c-8bd7-f14ffc3247b8",\n  "email": "mu@gabwe.com",\n  "roles": [\n    "Admin",\n    "Despot",\n    "Deceased"\n  ]\n}\n')),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"The values in this object don't represent the entirety of what's stored in the\ndatabase, just an example minimum amount needed for authentication. See the\n",(0,o.kt)("a",{parentName:"p",href:"/docs/graphql/schema#userjwt"},"GraphQL schema")," section for more information."))),(0,o.kt)("h3",{id:"access-token"},"Access token"),(0,o.kt)("p",null,"When the user logs in, assuming they've been a good boy and their login details\nare right, the server sends them an encrypted version of this object (the\n",(0,o.kt)("em",{parentName:"p"},"access token"),") which is stored on their end. Then, when they make a request,\nthey set the ",(0,o.kt)("inlineCode",{parentName:"p"},"Authorization")," header to include the token. Well, we set it for\nthem, because they're definitely not smart enough to do that themselves."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'Authorization: "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIi..."\n')),(0,o.kt)("p",null,"On the server, we use a magical library that checks if the token is valid, and\nwe are really trusting them to get this right, otherwise anyone could hack into\nour system. If it is, then we let them do whatever they were supposed to do."),(0,o.kt)("h3",{id:"refresh-token"},"Refresh token"),(0,o.kt)("p",null,"The only problem is, when the user refreshes the page, the access token\ndisappears. There are apparently very good security reasons for this that people\nhave written surprisingly long essays about. I find it a bit much so I won't\nlink it. That's right, suck my cheeks you long essays."),(0,o.kt)("p",null,"That's why, when the user logs in, we also send them a ",(0,o.kt)("em",{parentName:"p"},"refresh token"),", which\nencrypts the same information but with a different key, and is stored as a\ncookie. No, we don't ask for user consent for the cookies. We force that shit on\nthem and they just have to take it."),(0,o.kt)("p",null,"Since the encryption key on the refresh token is different, it can't be used to\naccess restricted information, but can be used to request a new access token for\nthe user. This is done by making a request to ",(0,o.kt)("inlineCode",{parentName:"p"},'"/jwt/refresh"')," with the cookie\nset, which is done automatically when the user refreshes. This token expires\nafter 7 days, so if the user waits that long, they have to log in again."),(0,o.kt)("h2",{id:"decorators"},"Decorators"),(0,o.kt)("h3",{id:"authauthenticated"},(0,o.kt)("inlineCode",{parentName:"h3"},"@Auth.authenticated()")),(0,o.kt)("p",null,"Restricted content on the server is done through GraphQL, so if one of our\nlittle users tries to be a bad boy and access stuff that they shouldn't, like\npulling on a fire alarm in a gathering when there's no fire and making their dad\nvery angry and giving mom a headache, then we restrict them. This is done using\nthe ",(0,o.kt)("inlineCode",{parentName:"p"},"@Auth.authenticated()")," decorator with a condition function. For example, if\nwe only want users to see the user profile page that belongs to their user while\nlogged in,"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="server/resolvers.ts" {3-5}',title:'"server/resolvers.ts"',"{3-5}":!0},"class Query implements QueryResolvers<Context> {\n  // ...\n  @Auth.authenticated(function (payload: UserJwt, args: { id: string }) {\n    return payload.id === args.id;\n  })\n  async readUserProfile(\n    _parent: unknown,\n    args: { id: string },\n    _context: Oak.Context,\n    _info: graphql.GraphQLResolveInfo,\n  ) {\n    // ...\n    return user;\n  }\n  // ...\n}\n")),(0,o.kt)("p",null,"Looks complicated, but to an enlightened soul like yours truly, all this does is\nit checks that the token the user sends with their request matches the user id\nof the profile that they're requesting."),(0,o.kt)("h3",{id:"authratelimit"},(0,o.kt)("inlineCode",{parentName:"h3"},"@Auth.rateLimit()")),(0,o.kt)("p",null,"Sometimes, someone isn't being a bad boy by not being logged in, but instead\nbeing a fucking asshole by spamming our shit. When someone does this, we use the\n",(0,o.kt)("inlineCode",{parentName:"p"},"@Auth.rateLimit()")," decorator and pass it a limit of the number of times they\ncan do it, and an expiry time in seconds. For example, if we want someone to\nonly be able to do a certain mutation a maximum of 5 times in 10 minutes,"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="server/resolvers.ts" {4}',title:'"server/resolvers.ts"',"{4}":!0},"// ...\nclass Mutation implements MutationResolvers<Context> {\n  // ...\n  @Auth.rateLimit({ limit: 5, expiry: 60 * 10 })\n  async doSomethingThatCostsUsALotOfMoney(\n    _parent: unknown,\n    args: {},\n    _context: Oak.Context,\n    _info: graphql.GraphQLResolveInfo,\n  ) {\n    // ...\n  }\n  // ...\n}\n")))}d.isMDXComponent=!0}}]);